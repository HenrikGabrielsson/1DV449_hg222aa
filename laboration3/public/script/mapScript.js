var mapElement=document.getElementById("mapDiv");var error;var messages;var map;var markers=[];var infowindows=[];var defaultMapOptions={center:{lat:63,lng:16},zoom:5};var categoryFilter=4;var areaFilter=0;var listSort=0;var socket=io.connect();var loadMap=function(){map=new google.maps.Map(mapElement,defaultMapOptions)};socket.on("trafficMessages",function(e){messages=e.messages;areas=e.areas;console.log(messages.length);if(messages!==undefined&&areas!==undefined){fillAreaDropdown(areas);updateAboutSection(e.dataRecievedTime,e.copyright);updatePage()}else{showError(e.error)}});var showError=function(e){var t=document.getElementById("errorMessage");if(e!==undefined){t.appendChild(document.createTextNode(e))}else{t.appendChild(document.createTextNode("Ett okänt fel har inträffat"))}};document.getElementById("sortMethodForm").addEventListener("change",function(e){var t=document.getElementById("listSortDropdown");listSort=Number(t.options[t.selectedIndex].value);updatePage()});document.getElementById("filterOptionsForm").addEventListener("change",function(e){var t=document.getElementById("categoryDropdown");categoryFilter=Number(t.options[t.selectedIndex].value);var n=document.getElementById("areaDropdown");var r=Number(n.options[n.selectedIndex].value);if(r!==areaFilter){areaFilter=r;updateMapOptions()}updatePage()},false);var updateMapOptions=function(){if(areaFilter===0){map.setOptions(defaultMapOptions);return}var e;for(var t=0;t<areas.length;t++){if(areas[t].trafficdepartmentunitid===areaFilter){e=areas[t];break}}var n=0;var r=0;var i=0;for(t=0;t<messages.length;t++){if(messages[t].area===e.trafficdepartmentunitid){n++;r+=messages[t].latitude;i+=messages[t].longitude}}if(n===0){map.setOptions(defaultMapOptions);return}map.setOptions({center:{lat:r/n,lng:i/n},zoom:e.zoom-1})};var fillAreaDropdown=function(e){var t=document.getElementById("areaDropdown");var n;if(t.children.length>1){return}var r=function(e,r){n=document.createElement("option");n.setAttribute("value",e);n.appendChild(document.createTextNode(r));t.appendChild(n)};r(0,"Visa alla");for(var i=0;i<e.length;i++){r(e[i].trafficdepartmentunitid,e[i].name)}};var updateAboutSection=function(e,t){var n=document.getElementsByClassName("lastUpdate")[0];var r=document.getElementsByClassName("copyright")[0];while(n.firstChild){n.removeChild(n.firstChild);r.removeChild(r.firstChild)}var i=document.createTextNode("Senaste uppdatering: "+getDateString(e));var s=document.createTextNode(t);n.appendChild(i);r.appendChild(s)};var updatePage=function(){var e=document.getElementById("messageList");var t;if(markers.length===0){t=document.createElement("ul");t.setAttribute("id","messageList_ul");e.appendChild(t)}else{t=document.getElementById("messageList_ul");while(t.firstChild){t.removeChild(t.firstChild)}for(var n=0;n<markers.length;n++){markers[n].setMap(null)}markers.length=0}var r;var i;if(listSort===1){for(var n=0;n<areas.length;n++){r=document.createElement("li");r.setAttribute("class","areaListItem hidden");i=document.createElement("ul");i.setAttribute("class","subList "+areas[n].trafficdepartmentunitid);r.appendChild(document.createTextNode(areas[n].name));r.appendChild(i);t.appendChild(r)}}var s;var o;var u;var a;sortList();for(var f=0;f<messages.length;f++){if((categoryFilter===4||categoryFilter===messages[f].category)&&(areaFilter===0||areaFilter===messages[f].area)){u={url:"../img/marker.png",origin:{x:(messages[f].priority-1)*22,y:0},size:{width:22,height:41}};s=new google.maps.LatLng(messages[f].latitude,messages[f].longitude);o=new google.maps.Marker({position:s,map:map,icon:u});addInfoWindow(o,messages[f]);if(listSort===0){t.appendChild(createListItem(messages[f],o))}else if(listSort===1){a=document.getElementsByClassName("subList "+messages[f].area)[0];a.appendChild(createListItem(messages[f],o));if(a.parentNode.getAttribute("class")=="areaListItem hidden"){a.parentNode.setAttribute("class","areaListItem")}}markers.push(o)}}};var sortList=function(){messages.sort(function(e,t){return Number(t.createddate.split("+")[0].slice(6))-Number(e.createddate.split("+")[0].slice(6))});if(listSort===1){var e=[];for(var t=0;t<areas.length;t++){for(var n=0;n<messages.length;n++){if(areas[t].trafficdepartmentunitid===messages[n].area){e.push(messages[n])}}}messages=e}};var addInfoWindow=function(e,t){var n;n=new google.maps.InfoWindow({content:createInfoWindowContent(t)});google.maps.event.addListener(e,"click",function(){for(var t=0;t<infowindows.length;t++){infowindows[t].close()}n.open(map,e)});infowindows.push(n)};var createInfoWindowContent=function(e){var t=document.createElement("div");var n=document.createElement("h2");var r=document.createElement("p");var i=document.createElement("p");var s=document.createElement("p");t.setAttribute("class","infowindow");n.setAttribute("class","infowindow_title");var o=getDateString(Number(e.createddate.split("+")[0].slice(6)));n.appendChild(document.createTextNode(e.title));r.appendChild(document.createTextNode("Vad: "+e.description));i.appendChild(document.createTextNode("När: "+o));s.appendChild(document.createTextNode("Typ: "+e.subcategory));t.appendChild(n);t.appendChild(r);t.appendChild(i);t.appendChild(s);return t};var createListItem=function(e,t){var n=document.createElement("li");var r=document.createElement("div");r.setAttribute("class","message");var i=document.createElement("div");i.setAttribute("class","message_header");var s=document.createElement("div");s.setAttribute("class","message_body");var o=document.createElement("p");var u=document.createElement("p");var a=document.createElement("p");var f=getDateString(Number(e.createddate.split("+")[0].slice(6)));var l=document.createElement("p");var c=document.createElement("p");l.appendChild(document.createTextNode(e.title));c.appendChild(document.createTextNode(f));i.appendChild(l);i.appendChild(c);o.appendChild(document.createTextNode("Var: "+e.exactlocation));u.appendChild(document.createTextNode("Typ: "+e.subcategory));a.appendChild(document.createTextNode("Beskrivning: "+e.description));s.appendChild(o);s.appendChild(u);s.appendChild(a);r.appendChild(i);r.appendChild(s);n.appendChild(r);n.addEventListener("click",function(){t.setAnimation(google.maps.Animation.BOUNCE);setTimeout(function(){t.setAnimation(null)},1400)},false);return n};var getDateString=function(e){var t=function(e){if(e<10){return"0"+e}return e};var n=new Date(e);var r=["Januari","Februari","Mars","April","Maj","Juni","Juli","Augusti","September","Oktober","November","December"];var i=n.getFullYear();var s=r[n.getMonth()];var o=n.getDate();var u=n.getHours();var a=n.getMinutes();var f=n.getSeconds();return t(u)+":"+t(a)+":"+t(f)+" "+o+" "+s+" "+i};google.maps.event.addDomListener(window,"load",loadMap)